<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommentNest - Live Comments</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #comments {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            max-height: 500px;
            overflow-y: auto;
        }
        .comment {
            margin-bottom: 15px;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .comment:last-child {
            border-bottom: none;
        }
        .user-name {
            font-weight: bold;
            color: #2c3e50;
        }
        .comment-text {
            margin: 5px 0;
        }
        .timestamp {
            font-size: 0.8em;
            color: #7f8c8d;
        }
        #status {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
<h1>CommentNest - Live Comments</h1>

<div id="status" class="disconnected">Отключено</div>

<div>
    <h3>Оставить комментарий:</h3>
    <div>
        <input type="text" id="userName" placeholder="Ваше имя"
               style="width: 200px; padding: 5px; margin-bottom: 10px; display: block;">
        <input type="email" id="userEmail" placeholder="Ваш email"
               style="width: 200px; padding: 5px; margin-bottom: 10px; display: block;">
        <div style="margin: 10px 0;">
            <div>Введите капчу: <strong>12345</strong></div>
            <input type="text" id="captcha" placeholder="Введите капчу" style="width: 200px; padding: 5px;">
        </div>
    </div>
    <div style="margin-top: 10px;">
        <textarea id="commentText" placeholder="Ваш комментарий"
                  style="width: 100%; height: 100px; padding: 5px;"></textarea>
    </div>
    <button id="sendButton" style="margin-top: 10px; padding: 5px 15px;">Отправить</button>
</div>

<h3>Комментарии:</h3>
<div id="comments">
    <p>Загрузка комментариев...</p>
</div>

<!-- Модальное окно для ответа на комментарий -->
<div id="replyModal"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 5px; width: 80%; max-width: 500px;">
        <h3>Ответ на комментарий <span id="replyToUser"></span></h3>
        <div>
            <input type="text" id="replyUserName" placeholder="Ваше имя"
                   style="width: 100%; padding: 5px; margin-bottom: 10px;">
            <input type="email" id="replyUserEmail" placeholder="Ваш email"
                   style="width: 100%; padding: 5px; margin-bottom: 10px;">
            <div style="margin: 10px 0;">
                <div>Введите капчу: <strong>12345</strong></div>
                <input type="text" id="replyCaptcha" placeholder="Введите капчу" style="width: 100%; padding: 5px;">
            </div>
            <textarea id="replyText" placeholder="Ваш ответ"
                      style="width: 100%; height: 100px; padding: 5px; margin-bottom: 10px;"></textarea>
            <div style="display: flex; justify-content: space-between;">
                <button id="cancelReply" style="padding: 5px 15px;">Отмена</button>
                <button id="submitReply" style="padding: 5px 15px;">Отправить ответ</button>
            </div>
        </div>
    </div>
</div>
<script>
        // 1. Получаем элемент для отображения статуса
        const statusEl = document.getElementById('status');
        // 2. Создаём переменную для хранения сокета
        let socket = null;

        // 3. Функция для подключения к сокету
        function connectWebSocket() {
        if (socket) {
            socket.close();
        }

        const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsUrl = wsProtocol + window.location.host + '/api/v1/ws/comments';
        socket = new WebSocket(wsUrl);
        console.log('Пытаемся подключиться к:', wsUrl);

        // Добавляем обработчик успешного подключения
        socket.onopen = function() {
            console.log('WebSocket соединение установлено');
            statusEl.textContent = 'Подключено';
            statusEl.className = 'connected';
        };

        // Добавляем обработчик закрытия соединения
        socket.onclose = function() {
            console.log('WebSocket соединение закрыто');
            statusEl.textContent = 'Отключено';
            statusEl.className = 'disconnected';
        };

        // Добавляем обработчик ошибок
        socket.onerror = function(error) {
            console.error('WebSocket ошибка:', error);
            statusEl.textContent = 'Ошибка подключения';
            statusEl.className = 'disconnected';
            };
        }

        // Функция для загрузки комментариев
            async function loadComments() {
            try {
                const response = await fetch('/api/v1/comments/with-replies?per_page=50');
                if (!response.ok) throw new Error('Ошибка загрузки комментариев');
                const comments = await response.json();
                displayComments(comments);
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('comments').innerHTML = '<p>Ошибка загрузки комментариев</p>';
            }
        }

        // Функция для отображения комментариев
        function displayComments(comments) {
            const container = document.getElementById('comments');
            if (!comments || comments.length === 0) {
                container.innerHTML = '<p>Комментариев пока нет. Будьте первым!</p>';
                return;
            }

            container.innerHTML = comments.map(comment => `
                <div class="comment" id="comment-${comment.id}">
                    <div class="user-name">${comment.user_name}</div>
                    <div class="comment-text">${comment.text}</div>
                    <div class="timestamp">${new Date(comment.created_at).toLocaleString()}</div>
                    <button onclick="showReplyModal(${comment.id}, '${comment.user_name}')"
                            class="reply-btn">Ответить</button>
                    ${comment.replies ? comment.replies.map(reply => `
                        <div class="reply">
                            <div class="user-name">${reply.user_name}</div>
                            <div class="comment-text">${reply.text}</div>
                            <div class="timestamp">${new Date(reply.created_at).toLocaleString()}</div>
                        </div>
                    `).join('') : ''}
                </div>
            `).join('');
        }

        // Загружаем комментарии при загрузке страницы
        document.addEventListener('DOMContentLoaded', loadComments);

        // Обновляем комментарии при получении нового через WebSocket
        if (socket) {
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'new_comment') {
                    loadComments(); // Перезагружаем комментарии
                }
            };
        }

        // Добавьте этот вызов в конец скрипта
        connectWebSocket()
</script>
</body>
</html>
